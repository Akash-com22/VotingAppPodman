name: Build and Push Docker Image with Podman

on:
  push:
    branches:
      - main

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: akashkam
  DOCKER_REPOSITORY: akashkam/podman

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Login to Docker registry by Podman
      run: |
        podman login  "${{ env.DOCKER_REGISTRY }}" -u "${{ env.DOCKER_USERNAME }}" -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Voting Application Build Image Using Podman
      run: |
        cd vote/
        podman build -t vote:v3 .
        podman push vote:v3 ${{ env.DOCKER_REPOSITORY }}:v3
        
    - name: Result Application Build Image Using Podman
      run: |
        cd result/
        podman build -t result:r3 .
        podman push localhost/result:r3 ${{ env.DOCKER_REPOSITORY }}:r3
  

    - name: Worker Application Build Image Using Podman
      run: |
        cd worker/
        podman build -t worker:w3 .
        podman push worker:w3 ${{ env.DOCKER_REPOSITORY }}:w3
    
    - name: Azure Kubernetes set context
      uses: Azure/aks-set-context@v3
      with:
        creds: "${{ secrets.AZURE_CREDENTIALS }}"
    # Resource Group Name
        resource-group: RG-Containerization2
    # AKS Cluster Name
        cluster-name: akscluster-002
    # AKS Cluster Subscription
        subscription: # optional
    # Get cluster admin credentials. Values: true or false
        admin: # optional
    # Enables kubelogin for non-admin user scenario. Values: true or false
        use-kubelogin: # optional
